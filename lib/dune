(data_only_dirs libexternals)

(rule
 (deps (source_tree libexternals))
 (targets libexternals.a dllexternals.so)
 (action
 (no-infer
  (progn
   (chdir libexternals (run make))
   (copy libexternals/externals.a libexternals.a)
   (copy libexternals/externals.so dllexternals.so)))))

(library
  (name suplex)
  (public_name suplex)
  (modes native)
  (libraries llvm llvm.executionengine llvm.analysis llvm.scalar_opts ppx_deriving core ctypes ctypes.foreign)
  (foreign_archives externals)
  (preprocess (pps ppx_deriving.show ppx_deriving.eq ppx_deriving.ord ppx_bin_prot))
  (instrumentation (backend bisect_ppx))
  (library_flags (-cclib lib/libexternals.a))
  (ocamlopt_flags (-g -rectypes))
)